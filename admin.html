<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Administrativo</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 90vh;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }
      .header h1 {
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .header-actions {
        display: flex;
        gap: 15px;
        align-items: center;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .btn-primary {
        background: #fff;
        color: #667eea;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-success:hover {
        background: #218838;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      .btn-danger:hover {
        background: #c82333;
      }

      .content {
        padding: 30px;
        overflow-y: auto;
        flex-grow: 1;
      }
      .section {
        display: none;
      }
      .section.activo {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .tabs {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 0;
      }
      .tab-btn {
        padding: 15px 25px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        color: #999;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: -2px;
      }
      .tab-btn.activo {
        color: #667eea;
        border-bottom-color: #667eea;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
      }
      .tab-btn:hover:not(.activo) {
        color: #667eea;
        background: #fafafa;
      }

      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal.activo {
        display: flex;
      }
      .modal-content {
        background: white;
        border-radius: 15px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      table thead {
        background: #f8f9fa;
      }
      table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
      }
      table td {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        vertical-align: middle;
      }
      table tr:last-child td {
        border-bottom: none;
      }

      .badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }
      .badge-admin {
        background: #dc3545;
        color: white;
      }
      .badge-usuario {
        background: #28a745;
        color: white;
      }
      .badge-empresa {
        background: #e2e8f0;
        color: #4a5568;
      }

      .estadisticas {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
      }
      .stat-card h3 {
        font-size: 32px;
        margin-bottom: 10px;
      }

      .mensaje {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }
      .mensaje.exito {
        background: #d4edda;
        color: #155724;
      }
      .mensaje.error {
        background: #f8d7da;
        color: #721c24;
      }

      .loading {
        opacity: 0.5;
        pointer-events: none;
      }

      /* Grid de Iconos */
      .icon-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 15px;
        max-height: 400px;
        overflow-y: auto;
        margin-top: 20px;
      }
        /* Updated Icon Item for Hover/Actions */
        .icon-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.2s;
            position: relative;
            cursor: pointer;
        }
        .icon-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: #667eea;
        }
        .icon-item img {
            max-width: 100%;
            height: 60px;
            object-fit: contain;
            margin-bottom: 5px;
        }
        .icon-item span {
            display: block;
            font-size: 11px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Tooltip */
        .custom-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            z-index: 3000;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .custom-tooltip.visible { opacity: 1; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

      .dashboard-companies {
        margin-top: 30px;
      }
      .dashboard-companies h3 {
        margin-bottom: 15px;
        color: #333;
      }

      /* Explorer Layout */
      .explorer-container {
        display: flex;
        height: 100%;
        gap: 20px;
      }
      .explorer-sidebar {
        width: 250px;
        border-right: 1px solid #e0e0e0;
        padding-right: 20px;
        overflow-y: auto;
      }
      .explorer-content {
        flex-grow: 1;
        overflow-y: auto;
      }
      .folder-item {
        padding: 10px;
        cursor: pointer;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #555;
        transition: background 0.2s;
      }
      .folder-item:hover {
        background: #f0f2f5;
      }
      .folder-item.activo {
        background: #e6ebf5;
        color: #667eea;
        font-weight: 600;
      }
      .explorer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-shield-alt"></i> Panel Admin</h1>
        <div class="header-actions">
          <span id="usuarioActual" style="font-size: 14px; opacity: 0.9"></span>
          <button class="btn btn-primary" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Salir
          </button>
        </div>
      </div>

      <div class="content">
        <div class="tabs">
          <button class="tab-btn activo" onclick="cambiarTab('dashboard')">
            <i class="fas fa-chart-bar"></i> Dashboard
          </button>
          <button class="tab-btn" onclick="cambiarTab('empresas')">
            <i class="fas fa-building"></i> Empresas
          </button>
          <button class="tab-btn" onclick="cambiarTab('usuarios')">
            <i class="fas fa-users"></i> Usuarios
          </button>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboardSection" class="section activo">
          <div class="estadisticas" id="estadisticas">
            <!-- Dinámico -->
          </div>

          <div class="dashboard-companies">
            <h3>Empresas Registradas</h3>
            <table id="tablaDashboardEmpresas">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbodyDashboardEmpresas"></tbody>
            </table>
          </div>
        </div>

        <!-- EMPRESAS -->
        <div id="empresasSection" class="section">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <h2>Gestión de Empresas</h2>
            <button class="btn btn-success" onclick="abrirModalNuevaEmpresa()">
              <i class="fas fa-plus"></i> Nueva Empresa
            </button>
          </div>
          <div id="mensajeEmpresas" class="mensaje"></div>
          <table id="tablaEmpresas">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>ID</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodyEmpresas"></tbody>
          </table>
        </div>

        <!-- USUARIOS -->
        <div id="usuariosSection" class="section">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <h2>Gestión de Usuarios</h2>
            <button class="btn btn-success" onclick="abrirModalNuevoUsuario()">
              <i class="fas fa-user-plus"></i> Nuevo Usuario
            </button>
          </div>
          <div id="mensajeUsuarios" class="mensaje"></div>
          <table id="tablaUsuarios">
            <thead>
              <tr>
                <th>Email</th>
                <th>Nombre</th>
                <th>Rol</th>
                <th>Empresa</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodyUsuarios"></tbody>
          </table>
        </div>

        <!-- EXPLORADOR DE EMPRESA -->
        <div id="explorerSection" class="section" style="height: 100%">
          <div
            class="explorer-header"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
              padding-bottom: 10px;
              border-bottom: 1px solid #eee;
            "
          >
            <div style="display: flex; align-items: center; gap: 15px;">
                <h2 id="explorerTitle">Explorando Empresa</h2>
            </div>
            <div style="display: flex; gap: 10px;">
                <button
                class="btn btn-success"
                onclick="abrirModalSubirIconoAdmin()"
                style="padding: 8px 15px; font-size: 13px;"
                >
                <i class="fas fa-upload"></i> Agregar Icono
                </button>
                <button
                class="btn"
                onclick="cerrarExplorer()"
                style="
                    background: #eee;
                    color: #333;
                    border: none;
                    padding: 10px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                "
                >
                <i class="fas fa-arrow-left"></i> Volver
                </button>
            </div>
          </div>

          <div
            id="loadingExplorer"
            style="display: none; text-align: center; padding: 40px"
          >
            <i class="fas fa-spinner fa-spin fa-3x" style="color: #667eea"></i>
            <p style="margin-top: 15px">Cargando estructura de la empresa...</p>
          </div>

          <div
            id="explorerBody"
            class="explorer-container"
            style="display: none; display: flex; height: 100%; gap: 20px"
          >
            <div
              class="explorer-sidebar"
              style="
                width: 250px;
                border-right: 1px solid #e0e0e0;
                padding-right: 20px;
                overflow-y: auto;
              "
            >
              <h4
                style="
                  margin-bottom: 15px;
                  color: #888;
                  font-size: 12px;
                  text-transform: uppercase;
                "
              >
                Carpetas
              </h4>
              <div id="listaCarpetas">
                <!-- Dinámico -->
              </div>
            </div>

            <div
              class="explorer-content"
              style="flex-grow: 1; overflow-y: auto"
            >
              <h4
                id="nombreCarpetaActual"
                style="margin-bottom: 15px; font-size: 18px"
              >
                Todos los Iconos
              </h4>
              <div
                id="gridIconosExplorer"
                class="icon-grid"
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                  gap: 15px;
                "
              >
                <!-- Dinámico -->
              </div>
              <div
                id="sinIconosExplorer"
                style="
                  display: none;
                  text-align: center;
                  padding: 40px;
                  color: #999;
                "
              >
                No hay iconos en esta vista.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL NUEVA EMPRESA -->
    <div id="modalNuevaEmpresa" class="modal">
      <div class="modal-content">
        <h2>Crear Nueva Empresa</h2>
        <div id="mensajeModalEmpresa" class="mensaje"></div>
        <div class="form-group">
          <label>Nombre de la Empresa:</label>
          <input
            type="text"
            id="nombreEmpresa"
            placeholder="Ej: Tech Solutions"
          />
        </div>
        <div class="modal-footer">
          <button
            class="btn"
            onclick="cerrarModales()"
            style="background: #999; color: white"
          >
            Cancelar
          </button>
          <button class="btn btn-success" onclick="crearEmpresa()">
            Guardar
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL NUEVO USUARIO -->
    <div id="modalNuevoUsuario" class="modal">
      <div class="modal-content">
        <h2>Crear Nuevo Usuario</h2>
        <div id="mensajeModalUsuario" class="mensaje"></div>
        <div class="form-group">
          <label>Email:</label>
          <input
            type="email"
            id="nuevoEmail"
            placeholder="usuario@empresa.com"
          />
        </div>
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" id="nuevoNombre" placeholder="Juan Pérez" />
        </div>
        <div class="form-group">
          <label>Contraseña:</label>
          <input
            type="password"
            id="nuevaClave"
            placeholder="Mínimo 8 caracteres"
          />
        </div>
        <div class="form-group">
          <label>Asignar Empresa:</label>
          <select id="nuevoEmpresaId">
            <option value="">-- Seleccionar --</option>
            <!-- Dinámico -->
          </select>
        </div>
        <div class="form-group">
          <label
            style="
              display: flex;
              align-items: center;
              gap: 10px;
              cursor: pointer;
            "
          >
            <input type="checkbox" id="nuevoEsAdmin" />
            ¿Es Administrador del Sistema?
          </label>
        </div>
        <div class="modal-footer">
          <button
            class="btn"
            onclick="cerrarModales()"
            style="background: #999; color: white"
          >
            Cancelar
          </button>
          <button class="btn btn-success" onclick="crearUsuario()">
            Guardar
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL EDITAR USUARIO -->
    <div id="modalEditarUsuario" class="modal">
      <div class="modal-content">
        <h2>
          Editar Usuario
          <span
            id="editarUsuarioEmailDisplay"
            style="font-size: 14px; opacity: 0.6"
          ></span>
        </h2>
        <div id="mensajeModalEditarUsuario" class="mensaje"></div>
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" id="editarNombre" placeholder="Juan Pérez" />
        </div>
        <div class="form-group">
          <label>Asignar Empresa:</label>
          <select id="editarEmpresaId">
            <option value="">-- Seleccionar --</option>
            <!-- Dinámico -->
          </select>
        </div>
        <div class="form-group">
          <label>Nueva Contraseña (Opcional):</label>
          <input
            type="password"
            id="editarClave"
            placeholder="Dejar vacío para mantener"
          />
          <small style="color: #666"
            >Ingresa una nueva contraseña solo si deseas cambiarla.</small
          >
        </div>
        <div class="modal-footer">
          <button
            class="btn"
            onclick="cerrarModales()"
            style="background: #999; color: white"
          >
            Cancelar
          </button>
          <button class="btn btn-primary" onclick="guardarEdicionUsuario()">
            Guardar Cambios
          </button>
        </div>
      </div>
    <!-- MODAL SUBIR ICONO ADMIN -->
    <div id="modalSubirIconoAdmin" class="modal">
      <div class="modal-content">
        <h2>Agregar Icono a Empresa</h2>
        <div id="mensajeModalSubirIcono" class="mensaje"></div>
        <div class="form-group">
          <label>URL de la Imagen:</label>
          <input type="url" id="urlIconoAdmin" placeholder="https://ejemplo.com/icono.png">
        </div>
        <div class="form-group">
          <label>Etiqueta:</label>
          <input type="text" id="etiquetaIconoAdmin" placeholder="Ej: Logo Facebook">
        </div>
        <div class="form-group">
          <label>Carpeta de Destino:</label>
          <select id="selectCarpetaIconoAdmin">
            <option value="">-- Sin Carpeta (General) --</option>
            <!-- Dinámico -->
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="cerrarModales()" style="background: #999; color: white">Cancelar</button>
          <button class="btn btn-primary" onclick="subirIconoAdmin()">Guardar Icono</button>
        </div>
      </div>
    </div>
    
    <!-- TOAST -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle" style="color: #2ecc71;"></i>
        <span>URL copiada al portapapeles</span>
    </div>

    <!-- ELIMINADO MODAL VER ICONOS ANTERIOR -->

    <script>
      // ⚠️ REEMPLAZA CON TU URL SI CAMBIA
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwH8UArErTudEEiTkjrNPCIuFJbYJaQzXAscW0A7HPDQLhwvZVgrXExPgmXqKOHGDeK/exec";

      let usuarioActual = null;
      let claveActual = null;

      let explorerCache = { carpetas: [], iconos: [] };
      let currentExplorerEmpresaId = null; // Para saber a cual subir

      let cacheEmpresas = []; // Cache local de empresas

      window.addEventListener("load", () => {
        const u = sessionStorage.getItem("usuarioAdmin");
        const c = sessionStorage.getItem("claveAdmin");

        if (u && c) {
          usuarioActual = u;
          claveActual = c;
          document.getElementById("usuarioActual").innerHTML =
            `Hola, <b>${u}</b>`;
          cargarTodo();
        } else {
          window.location.href = "index.html";
        }
      });

      async function cargarTodo() {
        await cargarEmpresas(); // Primero empresas para tener el cache
        cargarDashboard();
      }

      function cambiarTab(tab) {
        document
          .querySelectorAll(".section")
          .forEach((s) => s.classList.remove("activo"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("activo"));

        document.getElementById(`${tab}Section`).classList.add("activo");
        // Encontrar btn correspondiente
        const btns = document.querySelectorAll(".tab-btn");
        if (tab === "dashboard") btns[0].classList.add("activo");
        if (tab === "empresas") btns[1].classList.add("activo");
        if (tab === "usuarios") btns[2].classList.add("activo");

        if (tab === "dashboard") cargarDashboard();
        if (tab === "empresas") cargarEmpresas();
        if (tab === "usuarios") cargarUsuarios();
      }

      // ==================== DASHBOARD ====================
      async function cargarDashboard() {
        const users = await api("listarUsuarios");
        const empresas = await api("listarEmpresas");

        if (users && empresas) {
          const totalUsers = users.usuarios.length;
          const totalEmpresas = empresas.empresas.length;
          const totalAdmins = users.usuarios.filter(
            (u) => u.rol === "admin",
          ).length;

          document.getElementById("estadisticas").innerHTML = `
                    <div class="stat-card">
                        <h3>${totalEmpresas}</h3>
                        <p>Empresas Activas</p>
                    </div>
                    <div class="stat-card">
                        <h3>${totalUsers}</h3>
                        <p>Usuarios Totales</p>
                    </div>
                    <div class="stat-card">
                        <h3>${totalAdmins}</h3>
                        <p>Administradores</p>
                    </div>
                `;

          // Cargar lista de empresas en dashboard
          const tbody = document.getElementById("tbodyDashboardEmpresas");
          tbody.innerHTML = empresas.empresas
            .map(
              (e) => `
                    <tr>
                        <td><strong>${e.nombre}</strong></td>
                        <td>
                            <button class="btn btn-primary btn-pequeño" onclick="explorarEmpresa('${e.id}', '${e.nombre}')">
                                <i class="fas fa-folder-open"></i> Explorar
                            </button>
                        </td>
                    </tr>
                 `,
            )
            .join("");
        }
      }

      // ==================== EMPRESAS ====================
      async function cargarEmpresas() {
        const res = await api("listarEmpresas");
        if (res && res.success) {
          cacheEmpresas = res.empresas;
          const tbody = document.getElementById("tbodyEmpresas");
          tbody.innerHTML = res.empresas
            .map(
              (e) => `
                    <tr>
                        <td><strong>${e.nombre}</strong></td>
                        <td style="color: #999; font-family: monospace;">${e.id}</td>
                        <td>
                            <button class="btn btn-danger btn-pequeño" onclick="eliminarEmpresa('${e.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `,
            )
            .join("");

          // Actualizar select de modales
          actualizarSelectEmpresas();
        }
      }

      async function crearEmpresa() {
        const nombre = document.getElementById("nombreEmpresa").value;
        if (!nombre) return alert("Ingresa un nombre");

        const res = await api("crearEmpresa", { nombreEmpresa: nombre });
        if (res.success) {
          mostrarMensaje("mensajeModalEmpresa", "exito", "Empresa creada");
          document.getElementById("nombreEmpresa").value = "";
          setTimeout(() => {
            cerrarModales();
            cargarEmpresas();
          }, 1000);
        } else {
          mostrarMensaje("mensajeModalEmpresa", "error", res.error);
        }
      }

      async function eliminarEmpresa(id) {
        if (
          !confirm(
            "¿Estás seguro? Esto podría afectar a los usuarios asignados.",
          )
        )
          return;

        const res = await api("eliminarEmpresa", { idEmpresa: id });
        if (res.success) {
          cargarEmpresas(); // Recargar lista
        } else {
          alert("Error: " + res.error);
        }
      }

      // ==================== USUARIOS ====================
      async function cargarUsuarios() {
        const res = await api("listarUsuarios");
        if (res && res.success) {
          const tbody = document.getElementById("tbodyUsuarios");
          cacheUsuarios = res.usuarios; // Guardamos cache para editar
          tbody.innerHTML = res.usuarios
            .map((u) => {
              const empresaNombre =
                u.empresaNombre ||
                (u.empresaId ? buscarNombreEmpresa(u.empresaId) : "-");
              return `
                    <tr>
                        <td>${u.email}</td>
                        <td>${u.nombre}</td>
                        <td><span class="badge ${u.rol === "admin" ? "badge-admin" : "badge-usuario"}">${u.rol}</span></td>
                        <td><span class="badge badge-empresa">${empresaNombre}</span></td>
                        <td>
                            <button class="btn btn-primary btn-pequeño" onclick="abrirModalEditarUsuario('${u.email}')" title="Editar" style="margin-right: 5px; display: inline-flex;">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            ${
                              u.rol !== "admin" || u.email !== usuarioActual
                                ? `
                            <button class="btn btn-danger btn-pequeño" onclick="eliminarUsuario('${u.email}')" title="Eliminar" style="display: inline-flex;">
                                <i class="fas fa-trash"></i>
                            </button>`
                                : ""
                            }
                        </td>
                    </tr>
                `;
            })
            .join("");
        }
      }

      async function crearUsuario() {
        const email = document.getElementById("nuevoEmail").value;
        const nombre = document.getElementById("nuevoNombre").value;
        const clave = document.getElementById("nuevaClave").value;
        const empresaId = document.getElementById("nuevoEmpresaId").value;
        const esAdmin = document.getElementById("nuevoEsAdmin").checked;

        if (!email || !nombre || !clave) return alert("Datos incompletos");

        const res = await api("crearUsuario", {
          nuevoEmail: email,
          nuevoNombre: nombre,
          nuevaClave: clave,
          empresaId: empresaId,
          esAdmin: esAdmin,
        });

        if (res.success) {
          mostrarMensaje("mensajeModalUsuario", "exito", "Usuario creado");
          setTimeout(() => {
            cerrarModales();
            cargarUsuarios();
          }, 1000);
        } else {
          mostrarMensaje("mensajeModalUsuario", "error", res.error);
        }
      }

      async function eliminarUsuario(email) {
        if (!confirm("¿Eliminar usuario?")) return;
        const res = await api("eliminarUsuario", { usuarioTarget: email });
        if (res.success) cargarUsuarios();
        else alert(res.error);
      }

      let usuarioEnEdicionEmail = null;
      let cacheUsuarios = [];

      function abrirModalEditarUsuario(email) {
        const user = cacheUsuarios.find((u) => u.email === email);
        if (!user) return;

        usuarioEnEdicionEmail = email;
        document.getElementById("editarUsuarioEmailDisplay").textContent =
          email;
        document.getElementById("editarNombre").value = user.nombre;
        document.getElementById("editarClave").value = ""; // Limpiar siempre

        // Llenar select empresas
        const select = document.getElementById("editarEmpresaId");
        select.innerHTML =
          '<option value="">-- Sin Empresa --</option>' +
          cacheEmpresas
            .map(
              (e) =>
                `<option value="${e.id}" ${e.id === user.empresaId ? "selected" : ""}>${e.nombre}</option>`,
            )
            .join("");

        document.getElementById("modalEditarUsuario").classList.add("activo");
      }

      async function guardarEdicionUsuario() {
        if (!usuarioEnEdicionEmail) return;

        const nombre = document.getElementById("editarNombre").value;
        const empresaId = document.getElementById("editarEmpresaId").value;
        const nuevaClave = document.getElementById("editarClave").value;

        const boton = document.querySelector(
          "#modalEditarUsuario .btn-primary",
        );
        const textoOriginal = boton.textContent;
        boton.textContent = "Guardando...";
        boton.disabled = true;

        const datos = {
          nombre: nombre,
          empresaId: empresaId || null,
        };
        if (nuevaClave) datos.nuevaClave = nuevaClave;

        const res = await api("editarUsuario", {
          targetEmail: usuarioEnEdicionEmail,
          datos: datos,
        });

        if (res && res.success) {
          mostrarMensaje(
            "mensajeModalEditarUsuario",
            "exito",
            "Usuario actualizado",
          );
          setTimeout(() => {
            cerrarModales();
            cargarUsuarios();
          }, 1000);
        } else {
          mostrarMensaje(
            "mensajeModalEditarUsuario",
            "error",
            res.error || "Error al actualizar",
          );
        }

        boton.textContent = textoOriginal;
        boton.disabled = false;
      }

      // ==================== EXPLORADOR DE EMPRESA (Full Page) ====================



      async function explorarEmpresa(empresaId, nombreEmpresa) {
        if (!usuarioActual) return;

        // 1. Mostrar Sección Explorer
        document
          .querySelectorAll(".section")
          .forEach((s) => s.classList.remove("activo"));
        document.getElementById("explorerSection").classList.add("activo");

        // UI Reset
        document.getElementById("explorerTitle").textContent =
          `Explorando: ${nombreEmpresa}`;
        document.getElementById("explorerBody").style.display = "none";
        document.getElementById("loadingExplorer").style.display = "block";

        try {
          // Paso 1: Cambiar contexto a la empresa
          console.log("Cambiando contexto...", empresaId);
          const resCambio = await api("editarUsuario", {
            targetEmail: usuarioActual,
            datos: { empresaId: empresaId },
          });

          if (!resCambio || !resCambio.success)
            throw new Error("Error cambiando contexto");

          // Paso 2: Fetch paralelo de Carpetas e Iconos (como si fuera el admin de esa empresa)
          console.log("Obteniendo datos...");
          const [resCarpetas, resIconos] = await Promise.all([
            api("listarCarpetas"),
            api("listarIconos"),
          ]);

          // Paso 3: Restaurar contexto inmediatamente
          console.log("Restaurando contexto...");
          await api("editarUsuario", {
            targetEmail: usuarioActual,
            datos: { empresaId: null },
          });

          // Paso 4: Renderizar
          if (resCarpetas.success && resIconos.success) {
            explorerCache.carpetas = resCarpetas.carpetas;
            explorerCache.iconos = resIconos.iconos;
            currentExplorerEmpresaId = empresaId; // Guardar ID actual

            renderExplorerUI();

            document.getElementById("loadingExplorer").style.display = "none";
            document.getElementById("explorerBody").style.display = "flex";
          } else {
            alert("Error obteniendo datos parciales");
            cerrarExplorer();
          }
        } catch (e) {
          console.error(e);
          alert("Error: " + e.message);
          // Intento final de restaurar por seguridad
          await api("editarUsuario", {
            targetEmail: usuarioActual,
            datos: { empresaId: null },
          });
          cerrarExplorer();


        function abrirModalSubirIconoAdmin() {
            if (!currentExplorerEmpresaId) return alert("Error: No hay empresa seleccionada");
            
            // Llenar select carpetas con las de la empresa actual (cache)
            const select = document.getElementById('selectCarpetaIconoAdmin');
            select.innerHTML = '<option value="">-- Sin Carpeta (General) --</option>' + 
                explorerCache.carpetas.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
            
            document.getElementById('modalSubirIconoAdmin').classList.add('activo');
        }

        async function subirIconoAdmin() {
            const url = document.getElementById('urlIconoAdmin').value;
            const etiqueta = document.getElementById('etiquetaIconoAdmin').value;
            const carpetaId = document.getElementById('selectCarpetaIconoAdmin').value;
            
            if (!url) return alert('Ingresa una URL');

            const boton = document.querySelector('#modalSubirIconoAdmin .btn-primary');
            const textoOriginal = boton.textContent;
            boton.textContent = 'Guardando...';
            boton.disabled = true;

            try {
                // 1. Cambio de contexto
                await api('editarUsuario', {
                   targetEmail: usuarioActual,
                   datos: { empresaId: currentExplorerEmpresaId } 
                });

                // 2. Subir Icono (como si fuera esa empresa)
                const res = await api('subirIcono', {
                    url: url,
                    carpetaId: carpetaId || null,
                    etiqueta: etiqueta
                });

                // 3. Restaurar contexto
                await api('editarUsuario', {
                   targetEmail: usuarioActual,
                   datos: { empresaId: null } 
                });

                if (res.success) {
                    mostrarMensaje('mensajeModalSubirIcono', 'exito', 'Icono agregado');
                    // Actualizar vista localmente
                    explorerCache.iconos.push(res.icono);
                    
                    setTimeout(() => {
                        cerrarModales();
                        renderExplorerUI(); // Re-render simple
                        mostrarToast('Icono subido correctamente');
                    }, 1000);
                } else {
                     mostrarMensaje('mensajeModalSubirIcono', 'error', res.error);
                }

            } catch (e) {
                console.error(e);
                alert('Error en el proceso de subida');
                // Intentar asegurar restauración
                await api('editarUsuario', { targetEmail: usuarioActual, datos: { empresaId: null } });
            }
            
            boton.textContent = textoOriginal;
            boton.disabled = false;
        }

      function renderExplorerUI() {
        // Render Sidebar (Carpetas)
        const listaCarpetas = document.getElementById("listaCarpetas");
        listaCarpetas.innerHTML = `
                <div class="folder-item activo" onclick="filtrarExplorer('todos', this)">
                    <i class="fas fa-layer-group"></i> Todos
                </div>
                ${explorerCache.carpetas
                  .map(
                    (c) => `
                    <div class="folder-item" onclick="filtrarExplorer('${c.id}', this, '${c.nombre}')">
                        <i class="fas fa-folder"></i> ${c.nombre}
                    </div>
                `,
                  )
                  .join("")}
            `;

        // Render Inicial (Todos)
        filtrarExplorer("todos", listaCarpetas.firstElementChild);
      }

      function filtrarExplorer(filtro, el, nombreCarpeta = "Todos") {
        // Actualizar activo
        document
          .querySelectorAll(".folder-item")
          .forEach((i) => i.classList.remove("activo"));
        el.classList.add("activo");

        document.getElementById("nombreCarpetaActual").textContent =
          nombreCarpeta;

        let iconosFiltrados = [];
        if (filtro === "todos") {
          iconosFiltrados = explorerCache.iconos;
        } else {
          iconosFiltrados = explorerCache.iconos.filter(
            (i) => i.carpetaId === filtro,
          );
        }

        const grid = document.getElementById("gridIconosExplorer");
        const placeholder = document.getElementById("sinIconosExplorer");

        if (iconosFiltrados.length === 0) {
          grid.innerHTML = "";
          placeholder.style.display = "block";
        } else {
          placeholder.style.display = "none";
          grid.innerHTML = iconosFiltrados
            .map(
              (icon) => `
                    <div class="icon-item"
                         onclick="copiarUrl('${icon.url}')"
                         data-label="${icon.etiqueta || ''}"
                         onmouseenter="showTooltip(event, this)" 
                         onmouseleave="hideTooltip()"
                         onmousemove="updateTooltipPosition(event)">
                        <img src="${icon.url}" alt="Icono" onerror="this.src='https://via.placeholder.com/64?text=ABC'">
                        <span>${icon.etiqueta || 'Sin etiqueta'}</span>
                    </div>
                `,
            )
            .join("");
        }
      }

      function cerrarExplorer() {
        currentExplorerEmpresaId = null;
        cambiarTab("dashboard");
      }

      // ==================== TOOLTIP & COPY ====================
      let tooltipElem = null;

      function createTooltip() {
          if (!tooltipElem) {
              tooltipElem = document.createElement('div');
              tooltipElem.className = 'custom-tooltip';
              document.body.appendChild(tooltipElem);
          }
      }

      function showTooltip(e, element) {
          const label = element.getAttribute('data-label');
          if (!label) return;

          createTooltip();
          tooltipElem.textContent = label;
          tooltipElem.classList.add('visible');
          updateTooltipPosition(e);
      }

      function hideTooltip() {
          if (tooltipElem) tooltipElem.classList.remove('visible');
      }

      function updateTooltipPosition(e) {
          if (!tooltipElem || !tooltipElem.classList.contains('visible')) return;
          const offset = 15;
          let left = e.pageX + offset;
          let top = e.pageY + offset;
          
          if (left + tooltipElem.offsetWidth > window.innerWidth) left = e.pageX - tooltipElem.offsetWidth - offset;
          
          tooltipElem.style.left = `${left}px`;
          tooltipElem.style.top = `${top}px`;
      }

      function copiarUrl(url) {
          navigator.clipboard.writeText(url).then(() => {
              mostrarToast('URL copiada');
          }).catch(err => {
              console.error('Error al copiar', err);
          });
      }

      function mostrarToast(texto) {
          const toast = document.getElementById('toast');
          toast.querySelector('span').textContent = texto;
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), 3000);
      }

      // ==================== HELPERS ====================
      async function api(accion, data = {}) {
        try {
          const body = {
            accion: accion,
            email: usuarioActual,
            clave: claveActual,
            ...data,
          };

          const response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(body),
          });
          return await response.json();
        } catch (e) {
          console.error(e);
          alert("Error de conexión");
          return null;
        }
      }

      function buscarNombreEmpresa(id) {
        const emp = cacheEmpresas.find((e) => e.id === id);
        return emp ? emp.nombre : "ID Desconocido";
      }

      function actualizarSelectEmpresas() {
        const select = document.getElementById("nuevoEmpresaId");
        if (!select) return;
        select.innerHTML =
          '<option value="">-- Sin Empresa --</option>' +
          cacheEmpresas
            .map((e) => `<option value="${e.id}">${e.nombre}</option>`)
            .join("");
      }

      function abrirModalNuevaEmpresa() {
        document.getElementById("modalNuevaEmpresa").classList.add("activo");
      }
      function abrirModalNuevoUsuario() {
        document.getElementById("modalNuevoUsuario").classList.add("activo");
        actualizarSelectEmpresas();
      }
      function cerrarModales() {
        document
          .querySelectorAll(".modal")
          .forEach((m) => m.classList.remove("activo"));
        document.querySelectorAll("input").forEach((i) => (i.value = ""));
      }

      function mostrarMensaje(id, tipo, texto) {
        const el = document.getElementById(id);
        el.textContent = texto;
        el.className = `mensaje ${tipo}`;
        el.style.display = "block";
      }

      function logout() {
        sessionStorage.clear();
        window.location.href = "index.html";
      }
    </script>
  </body>
</html>
