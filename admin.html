<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-actions {
            display: flex;
            gap: 15px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: #fff;
            color: #667eea;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .content {
            padding: 40px;
        }
        .section {
            display: none;
        }
        .section.activo {
            display: block;
        }
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #999;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn.activo {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.activo {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .modal-content h2 {
            margin-bottom: 25px;
            color: #333;
        }
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table thead {
            background: #f8f9fa;
        }
        table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }
        table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        table tr:hover {
            background: #f8f9fa;
        }
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-admin {
            background: #dc3545;
            color: white;
        }
        .badge-usuario {
            background: #28a745;
            color: white;
        }
        .acciones {
            display: flex;
            gap: 8px;
        }
        .btn-peque침o {
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn-editar {
            background: #007bff;
            color: white;
        }
        .btn-editar:hover {
            background: #0056b3;
        }
        .btn-eliminar {
            background: #dc3545;
            color: white;
        }
        .btn-eliminar:hover {
            background: #c82333;
        }
        .mensaje {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .mensaje.exito {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .mensaje.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .estadisticas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> Panel Administrativo</h1>
            <div class="header-actions">
                <span id="usuarioActual" style="font-size: 14px;"></span>
                <button class="btn btn-primary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi칩n
                </button>
            </div>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab-btn activo" onclick="cambiarTab('dashboard')">
                    <i class="fas fa-chart-bar"></i> Dashboard
                </button>
                <button class="tab-btn" onclick="cambiarTab('usuarios')">
                    <i class="fas fa-users"></i> Gestionar Usuarios
                </button>
            </div>

            <div id="dashboardSection" class="section activo">
                <h2>Dashboard</h2>
                <div class="estadisticas" id="estadisticas"></div>
            </div>

            <div id="usuariosSection" class="section">
                <h2>Gesti칩n de Usuarios</h2>
                <div id="mensajeUsuarios" class="mensaje"></div>
                <button class="btn btn-success" onclick="abrirModalNuevoUsuario()">
                    <i class="fas fa-user-plus"></i> Crear Nuevo Usuario
                </button>
                <table id="tablaUsuarios">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Nombre</th>
                            <th>Rol</th>
                            <th>Empresa</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyUsuarios"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalNuevoUsuario" class="modal">
        <div class="modal-content">
            <h2>Crear Nuevo Usuario</h2>
            <div id="mensajeModal" class="mensaje"></div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="nuevoEmail" placeholder="usuario@empresa.com">
            </div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="nuevoNombre" placeholder="Juan P칠rez">
            </div>
            <div class="form-group">
                <label>Contrase침a:</label>
                <input type="password" id="nuevaClave" placeholder="Contrase침a segura">
            </div>
            <div class="form-group">
                <label>Empresa:</label>
                <select id="nuevoEmpresa">
                    <option value="">Seleccionar...</option>
                    <option value="Empresa 1">Empresa 1</option>
                    <option value="Empresa 2">Empresa 2</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="nuevoEsAdmin">
                    쮼s Administrador?
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="cerrarModal('modalNuevoUsuario')" style="background: #999; color: white;">
                    Cancelar
                </button>
                <button class="btn btn-success" onclick="crearUsuario()">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>

    <div id="modalEditarEmpresa" class="modal">
        <div class="modal-content">
            <h2>Cambiar Empresa</h2>
            <p id="emailEditando" style="margin-bottom: 20px; color: #666;"></p>
            <div class="form-group">
                <label>Nueva Empresa:</label>
                <select id="editarEmpresa">
                    <option value="">Seleccionar...</option>
                    <option value="Empresa 1">Empresa 1</option>
                    <option value="Empresa 2">Empresa 2</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="cerrarModal('modalEditarEmpresa')" style="background: #999; color: white;">
                    Cancelar
                </button>
                <button class="btn btn-success" onclick="guardarCambioEmpresa()">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzvAqH3GH_zv7YcSEhXVKjlSJe3XivIZZYrEC7V7Bq1eRkYiUmWz-gnz1lEwH7bEUDT/exec';
        let usuarioActual = null;
        let claveActual = null;
        let usuarioEditando = null;

        window.addEventListener('load', () => {
            const usuarioGuardado = sessionStorage.getItem('usuarioAdmin');
            const claveGuardada = sessionStorage.getItem('claveAdmin');

            if (usuarioGuardado && claveGuardada) {
                usuarioActual = usuarioGuardado;
                claveActual = claveGuardada;
                document.getElementById('usuarioActual').textContent = `游녻 ${usuarioActual}`;
                cargarDashboard();
                cargarUsuarios();
            } else {
                window.location.href = 'index.html';
            }
        });

        function cambiarTab(tab) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('activo'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('activo'));

            if (tab === 'dashboard') {
                document.getElementById('dashboardSection').classList.add('activo');
                document.querySelectorAll('.tab-btn')[0].classList.add('activo');
                cargarDashboard();
            } else if (tab === 'usuarios') {
                document.getElementById('usuariosSection').classList.add('activo');
                document.querySelectorAll('.tab-btn')[1].classList.add('activo');
                cargarUsuarios();
            }
        }

        async function cargarDashboard() {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        accion: 'listarUsuarios',
                        email: usuarioActual,
                        clave: claveActual
                    })
                });

                const usuarios = await response.json();

                if (Array.isArray(usuarios)) {
                    const totalUsuarios = usuarios.length;
                    const totalAdmins = usuarios.filter(u => u.rol === 'admin').length;
                    const empresa1 = usuarios.filter(u => u.empresa === 'Empresa 1').length;
                    const empresa2 = usuarios.filter(u => u.empresa === 'Empresa 2').length;

                    document.getElementById('estadisticas').innerHTML = `
                        <div class="stat-card">
                            <h3>${totalUsuarios}</h3>
                            <p>Total de Usuarios</p>
                        </div>
                        <div class="stat-card">
                            <h3>${totalAdmins}</h3>
                            <p>Administradores</p>
                        </div>
                        <div class="stat-card">
                            <h3>${empresa1}</h3>
                            <p>Usuarios Empresa 1</p>
                        </div>
                        <div class="stat-card">
                            <h3>${empresa2}</h3>
                            <p>Usuarios Empresa 2</p>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Error:', e);
            }
        }

        async function cargarUsuarios() {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        accion: 'listarUsuarios',
                        email: usuarioActual,
                        clave: claveActual
                    })
                });

                const usuarios = await response.json();

                if (Array.isArray(usuarios)) {
                    let html = '';
                    usuarios.forEach(user => {
                        const rolBadge = user.rol === 'admin' 
                            ? '<span class="badge badge-admin">Admin</span>'
                            : '<span class="badge badge-usuario">Usuario</span>';
                        
                        const empresaBadge = user.empresa 
                            ? `<span style="color: #667eea; font-weight: 600;">${user.empresa}</span>`
                            : '<span style="color: #999;">-</span>';

                        html += `
                            <tr>
                                <td>${user.email}</td>
                                <td>${user.nombre}</td>
                                <td>${rolBadge}</td>
                                <td>${empresaBadge}</td>
                                <td>
                                    <div class="acciones">
                                        <button class="btn btn-peque침o btn-editar" onclick="abrirModalEditarEmpresa('${user.email}')">
                                            <i class="fas fa-edit"></i> Empresa
                                        </button>
                                        <button class="btn btn-peque침o btn-eliminar" onclick="confirmarEliminar('${user.email}')">
                                            <i class="fas fa-trash"></i> Eliminar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    document.getElementById('tbodyUsuarios').innerHTML = html;
                }
            } catch (e) {
                mostrarMensaje('mensajeUsuarios', 'error', 'Error cargando usuarios');
            }
        }

        function abrirModalNuevoUsuario() {
            document.getElementById('modalNuevoUsuario').classList.add('activo');
        }

        async function crearUsuario() {
            const email = document.getElementById('nuevoEmail').value;
            const nombre = document.getElementById('nuevoNombre').value;
            const clave = document.getElementById('nuevaClave').value;
            const empresa = document.getElementById('nuevoEmpresa').value;
            const esAdmin = document.getElementById('nuevoEsAdmin').checked;

            if (!email || !nombre || !clave) {
                mostrarMensaje('mensajeModal', 'error', 'Completa todos los campos');
                return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        accion: 'crearUsuario',
                        email: usuarioActual,
                        clave: claveActual,
                        nuevoEmail: email,
                        nuevoNombre: nombre,
                        nuevaClave: clave,
                        empresa: empresa || null,
                        esAdmin: esAdmin
                    })
                });

                const resultado = await response.json();

                if (resultado.success) {
                    mostrarMensaje('mensajeModal', 'exito', 'Usuario creado correctamente');
                    setTimeout(() => {
                        cerrarModal('modalNuevoUsuario');
                        cargarUsuarios();
                    }, 1500);
                } else {
                    mostrarMensaje('mensajeModal', 'error', resultado.error);
                }
            } catch (e) {
                mostrarMensaje('mensajeModal', 'error', 'Error: ' + e.message);
            }
        }

        function abrirModalEditarEmpresa(email) {
            usuarioEditando = email;
            document.getElementById('emailEditando').textContent = `Email: ${email}`;
            document.getElementById('modalEditarEmpresa').classList.add('activo');
        }

        async function guardarCambioEmpresa() {
            const nuevaEmpresa = document.getElementById('editarEmpresa').value;

            if (!nuevaEmpresa) {
                alert('Selecciona una empresa');
                return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        accion: 'editarEmpresaUsuario',
                        email: usuarioActual,
                        clave: claveActual,
                        usuarioTarget: usuarioEditando,
                        nuevaEmpresa: nuevaEmpresa
                    })
                });

                const resultado = await response.json();

                if (resultado.success) {
                    mostrarMensaje('mensajeUsuarios', 'exito', 'Empresa actualizada');
                    cerrarModal('modalEditarEmpresa');
                    cargarUsuarios();
                } else {
                    alert('Error: ' + resultado.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function confirmarEliminar(email) {
            if (confirm(`쮼liminar usuario ${email}?`)) {
                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            accion: 'eliminarUsuario',
                            email: usuarioActual,
                            clave: claveActual,
                            usuarioTarget: email
                        })
                    });

                    const resultado = await response.json();

                    if (resultado.success) {
                        mostrarMensaje('mensajeUsuarios', 'exito', 'Usuario eliminado');
                        cargarUsuarios();
                    } else {
                        mostrarMensaje('mensajeUsuarios', 'error', resultado.error);
                    }
                } catch (e) {
                    mostrarMensaje('mensajeUsuarios', 'error', 'Error: ' + e.message);
                }
            }
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('activo');
            document.querySelectorAll('.modal-content input, .modal-content select').forEach(el => {
                el.value = '';
                if (el.type === 'checkbox') el.checked = false;
            });
        }

        function mostrarMensaje(elementId, tipo, texto) {
            const elemento = document.getElementById(elementId);
            elemento.textContent = texto;
            elemento.className = `mensaje ${tipo}`;
            setTimeout(() => {
                elemento.className = 'mensaje';
            }, 3000);
        }

        function logout() {
            sessionStorage.removeItem('usuarioAdmin');
            sessionStorage.removeItem('claveAdmin');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
